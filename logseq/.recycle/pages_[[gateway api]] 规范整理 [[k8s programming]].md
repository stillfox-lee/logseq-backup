title:: gateway api]] 规范整理 #k8s #[[k8s programming

-
- [ref](https://gateway-api.sigs.k8s.io/)
- 为什么需要 Gateway API？
	- 目的是通过强表达力的、可扩展的和面向角色的接口来发展Kubernetes服务网络，这些接口由许多供应商实现，并得到广泛的行业支持。
- 抽象出了类似于：`GatewayClass` `Gateway` `HTTPRoute` `Service`等
- ![](https://raw.githubusercontent.com/stillfox-lee/image/main/picgo/20220715172735.png){:height 464, :width 746}
- 概念
	- Role-oriented
	- 可移植性
	- 表达力
		- 基于 Header 的匹配，流量权重匹配等，在 Ingress 只能通过 annotation 实现
	- 可拓展性
		- 允许 CRD 在 API 的不同层次上被链接。
- 值得注意的能力
	- GatewayClass
		- GatewayClass 正式确定了负载均衡的实现的类型。这些类让用户能够更加简单明了地知道，通过 k8s 资源模型可以获得什么样的能力。
	- Shared Gateway 和多 Namespace 支持
		- 通过允许独立的`Route`资源附加到同一个Gateway来支持负载均衡和 VIP的共享。这就允许团队(甚至跨 Namespace)安全地共享基础设施，而不需要进行另外的协调工作。
	- 类型化的 Route 和类型化的 backend
		- Gateway API 支持类型化的`Route`资源和不同类型 backend。这使得 API 可以灵活地支持各种协议(HTTP 和 gRPC)和各种 backend 目标(k8s Service、storage buckets 或者是函数)。
- 为什么 role-oriented API 很重要
	- Gateway 是一种基础设施，它是为了在各个业务中共享而存在的。带来的挑战是：如何让基础设施为用户提供灵活性，同时让管理者还能够控制它？
	- GatewayAPI 通过对 k8s 的服务网络进行 role-oriented 设计来实现这个目标，在分布式的灵活性和集中式的控制之间取得了平衡。它允许共享的网络基础设施(硬件负载均衡器、云网络、集群托管的 proxy等)被许多不同的、独立的团队使用；而且所有的这些都受到集群的维护者设置的策略约束。
	- 参考下面的例子：
		- ![](https://raw.githubusercontent.com/stillfox-lee/image/main/picgo/20220716165754.png){:height 354, :width 686}
		- 一个集群的维护者创建了一个源自`GatewayClass`的`Gateway`资源。这个`Gateway`部署或配置它所代表的基础网络资源。通过`Gateway`和`Route`之间的 Route Attachment Process，集群的维护者和各个团队必须确认：什么可以添加到这个`Gateway`？怎么通过`Gateway`暴露他们的应用？
		- 集群维护者可以强制启用：集中式的策略(Default Policies)和 TLS。同时，Site 和 Store 的应用分别在他们各自的 Namespace 中运行，通过将`Route`添加到一个共享的`Gateway`，团队可以自由地控制他们自己的路由逻辑。这种`SoC`式的设计，能够使得团队的应用开发者只管理自己的流量策略，而将集中的策略和控制留给集群维护者去管理。
- API overview
	- roles
		- Infrastructure Provider
		- Cluster Operator
		- Application Developer
		- 在一些场景中，可能会有Application Admin 这个角色。
	- Resource Model：
		- #+BEGIN_NOTE
		  Gateway API 资源属于`gateway.networking.k8s.io` API group下的 CRD。
		  #+END_NOTE
		- GatewayClass
			- 为一组 gateways 定义了共同的配置和行为。每个`GatewayClass`对应一个 controller，controller 可能会对应多个`GatewayClass`。
			- `GatewayClass`是一个 cluster 范围的资源。为了实现一个功能性网关，必须至少定义一个`GatewayClass`。controller 通过提供一个相关的`GatewayClass`资源来实现 Gateway API，让用户可以通过在他们的 Gateway 中使用它(`GatewayClass`)。
			- 类似的概念还有`IngressClass`与`Ingress`，`StorageClass`与`PersistentVolume`。
		- Gateway
			- `Gateway`描述了如何将流量被分配到集群中的各个 Service 。它定义了一个请求，该如何从不了解 k8s地方转换到了解 k8s 的地方。例如，从公有云的负载均衡器、集群内部代理或者外部硬件负载均衡器，发送到 k8s 的流量。
			- 它为负载均衡器定义了请求的配置，该配置实现了`GatewayClass`的契约。`Gateway`资源可以由运维创建，也可以由处理`GatewayClass`的 Controller 创建。
			- `Gateway`的 Spec 可能不会包含所有的属性，有些字段例如 address、TLS是可以省略的。`GatewayClass`的 Controller 会为用户添加这些设置。**这种行为通过`GatewayClass`的 Status 对象来确定**。
			- `Gateway`可以附加到一个或者多个`Route`上，这些`Route`的作用是将流量的子集导向特定的服务。
		- Route
			- `Route`资源定义了如何将请求从`Gateway`映射到 k8s Services。现阶段只有 4 种 Route 资源，今后可能会添加更多的类型。
			- HTTPRoute
			- TLSRoute
			- TCPRoute
			- UDPRoute
	- 将 Route 添加到 Gateway
		- 关于 Route 如何添加到 Gateway，Gateway 对于 Route 的限制逻辑。在这些资源本身就有控制逻辑在进行管理。与 k8s 的`RBAC`一起，这些逻辑控制了 Route 如何向 Gateway 暴露，Route 如何添加到 Gateway 上。
		- Route 与 Gateway 的关系：
			- 一对一：一个 Gateway 对应一个 Route
			- 一对多：一个 Gateway 有多个 Route，这些 Route 由不同的 Namespace 的不同团队拥有。
			- 多对一：Route 可以绑定到多个 Gateway 上，允许一个 Route 在不同的 IP、LB 或者网络上。
	- 例子
		- 考虑以下的场景需求：
			- ![](https://raw.githubusercontent.com/stillfox-lee/image/main/picgo/20220803105526.png)
			- 有TeamA、TeamB、TeamC 三个团队，他们使用各自的 Namespace。TeamA 和 TeamB 之间可以使用共享网关，那么他们就可以将自己的 Route 添加到可共同使用的`shared-gw`资源；但是 TeamC 需要使用自己独享的网关*(安全或者性能原因)*，那么就需要一个独立的`dedicated-gw`，而且这个网关也只能对 TeamC 开放。
		- 如何实现？
			- 将Route关联到 Gateway
				- Route 需要通过`parentRef`来指定一个它需要关联的 Gateway。
				- 一个活跃的Gateway，允许 Route添加到它的路由上。
			- 在 Route 中引用 Gateway：
				- 在`parentRef`指定 Gateway。`parentRef`可以通过两个子规则：`sectionName`和`port`进一步筛选 Gateway。*`sectionName`是对 Gateway 进行名字匹配*
			- Gateway 如何限制 Route：
				- **Hostname**：Gateway 可以设置一个`hostname`，那么只有具有对应 hostname 的 Route 才能配添加到 Gateway。
				- **Namespace**：Gateway 可以通过设置`allowedRoutes.namepsages`字段来根据 Namespace限制添加到 Gateway 的 Route。
				- **Kinds**：Gateway 可以通过对 Route 的 Kind 来限制。
				-
	-