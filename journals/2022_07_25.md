- [[Flannel]] UDP 模式 #k8s [[k8s network]]
	- ![flannel udp](https://raw.githubusercontent.com/stillfox-lee/image/main/picgo/20220725091855.png)
	- 通过一种`TUN`隧道，在容器 bridge 与 flanneld 进程之间建立了一个网络隧道。使得 bridge 的数据可以发送到 flanneld 中进行转发处理。
	- 数据包进入到 flanneld 进程之后，会将 3 层的`packet`封装为 4 层的 UDP `datagrams`。再通过 eth0 发送到目标主机。
	- 这种技术的明显弱点是：数据多次的在 user space 与 kernel space 之间传输。
	-
- [[Flannel]] 的 [[VXLAN]]模式 #[[k8s network]]
	- 是一种针对于 UDP 方案的优化。UDP 方案中，UDP 包的封装和解包是在用户态进行的。而 VXLAN 方案是由内核完成这个步骤的。
	- 设计思想：在原本二层中的`frame`封装到四层UDP的`datagrams`。 在现有的三层网络上，“覆盖”一层虚拟的、由内核 VXLAN 模块负责维护的二层网络。属于一种 [[Overlay Network]]技术。
	- VTEP 设备
		- VXLAN tunnel end point
		- 对三层的 IP `packet`进行二层`frame`的封包和解包，为`packet`添加`MAC`地址，将 IP 包转换为一个二层数据帧，以实现 [[Overlay Network]]。
		- 具有 IP 地址和 MAC 地址
		- 由内核模块负责处理网络数据
	- 数据包的流转过程
		- ![](https://raw.githubusercontent.com/stillfox-lee/image/main/picgo/20220729101805.png)
	- DONE 对 flannel 的 VXLAN 总结
	  :LOGBOOK:
	  CLOCK: [2022-07-29 Fri 10:18:15]--[2022-07-29 Fri 10:18:16] =>  00:00:01
	  CLOCK: [2022-07-29 Fri 10:18:22]--[2022-07-29 Fri 10:18:23] =>  00:00:01
	  :END:
		- 为什么需要这个东西？
		- 整个过程中，如何拆包、封包
	-
- [[k8s network]] 的 [[CNI]] 原理
	- CNI 插件的工作：通过某种方法，将不同的 host 上的特殊设备连通，从而达到容器跨主机通信的目的。
	- k8s 会在创建 Pod 的时候，先创建一个`Infra`容器，在`Infra`容器启动之后，调用[[CNI]]网络插件，为这个容器 Namespace配置相应的网络栈。
		- Namespace 网络栈包括
			- 网卡
			- loop back
			- 路由表
			- iptables 规则
	- CNI 插件类型
		- Main 插件。用于创建具体的网络设备，如 Bridge、ipvlan、loopback、macvlan、veth pair 等
		- IPAM (IP Address Management)插件。负责分配 IP 地址，如 dhcp、host-local
		- 社区 CNI 插件。flannel、tuning、portmap、bandwith 等。